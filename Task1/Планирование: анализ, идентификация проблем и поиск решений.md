# Планирование: анализ, идентификация проблем и поиск решений

## 1. Список проблемных мест

### П1. Потеря заказов
CRM фиксирует ежедневные жалобы B2B партнёров и B2C клиентов на пропавшие заказы; фактический срок выполнения вырос с 3 недель до нескольких месяцев, крупные партнёры прекратили сотрудничество. Причины: очереди RabbitMQ без persistence и DLQ, обработчики неидемпотентны, нет контроля цепочки Shop > CRM > MES.

### П2. Медленный дашборд MES
После открытия дашборда операторы не видят новые заказы и не берут их в работу. Причины: N+1 запросы, отсутствие индексов и кеша, блокировки при росте объёма заказов.

### П3. Нет наблюдаемости
Нет автоматических алертов: сбои фиксируются только после жалобы клиента, MTTD зависит от времени получения жалобы. Причины: нет метрик, трейсинга, структурированных логов и алертов.

### П4. Ограничения масштабирования
Каждое приложение и БД запущены в единственном экземпляре; рост заказов +100 в месяц и двукратный потенциал производства могут привести к остановке сервиса из‑за единой точки отказа.

### П5. Узкое место B2B API
Синхронный вызов расчёта занимает до 30 минут; внешние партнёры получают HTTP 504 и не понимают, создан ли заказ. Причины: синхронный расчёт 2‑30 минут, отсутствие rate limiting и изоляции потоков.

### П6. Общая БД Shop и CRM
Обе системы работают с `shop_db`, что создаёт блокировки, зависимость схем и невозможность масштабирования по сервисам.

### П7. Ручной процесс тестирования
Регресс запускается вручную, релизы откатываются из‑за дефектов, прошедших на прод. Причины: отсутствуют автотесты и дымовые проверки, 1 QA выполняет всё регрессионное тестирование.

### П8. Несогласованность данных заказов
Данные дублируются в `shop_db` и `mes_db`. Причины: нет шаблонов Outbox/Inbox и мониторинга задержек доставки событий.

### П9. Неустойчивая интеграция RabbitMQ
Сбой RabbitMQ обрывает доставку событий: сообщения OrderStatusUpdated не доходят до CRM/MES, заказы остаются в статусе «в обработке», пока оператор вручную не перезапустит задачу. Причины: нет persistence, acknowledgments, DLQ, retry и circuit breaker.

## 2. Список инициатив для устранения проблем

Примечание: целевые значения метрик приведены как ориентировочные и требуют уточнения после внедрения мониторинга.

### И1. Наблюдаемость (П3, П1, П2)
Метрики, трейсинг и структурированные логи с алертами по ключевым SLA. **Критерий успеха:** MTTD <=5 минут (Prometheus + Alertmanager), есть SLI по количеству заказов в статусах и глубине очереди RabbitMQ (Grafana дашборд).

### И2. Надёжная работа RabbitMQ (П9, П1)
Persistence, acknowledgments, DLQ, retry с backoff, circuit breaker. **Критерий успеха:** 0 потерянных сообщений (сравнение Outbox<>Inbox), доля событий в DLQ <=0.5% (RabbitMQ exporter), автоматический алерт при превышении.

### И3. Идемпотентность обработки заказов (П1, П8)
Inbox/Outbox, учёт обработанных сообщений, оптимистичные блокировки. **Критерий успеха:** дубликаты статусов <0.1% (отчёт CRM), расхождение Shop<>MES <=0.5% заказов (сверка nightly job).

### И4. Оптимизация дашборда MES (П2)
Профилирование, индексы, устранение N+1 запросов, короткий кеш списка. **Критерий успеха:** P95 загрузки страницы <=2 секунды (RUM + Prometheus), очередь операторов <=5 минут (метрика CRM).

### И5. Асинхронный B2B API (П5)
Ответ «принято» сразу, статус через polling/webhook, расчёт вынесен в очередь. **Критерий успеха:** 99% запросов завершаются <=1 секунды (API Gateway logs), уведомление о готовности не позже 30 минут (CRM отчёт по SLA).

### И6. API Gateway и rate limiting (П5)
Разделение внешнего/внутреннего трафика, квоты и авторизация по ключам. **Критерий успеха:** B2B клиенты не превышают 100 req/min (Gateway metrics), нет деградации B2C SLA (Shop API latency Prometheus).

### И7. Горизонтальное масштабирование приложений (П4)
2+ инстанса за балансировщиком, stateless, auto scaling и health‑checks.

### И8. Репликация БД (П4, П2)
Master для записи, read‑реплики для SELECT, мониторинг отставания.

### И9. Автоматизированные тесты (П7)
Дымовые тесты и регрессия в CI, критичные сценарии покрыты автотестами.

### И10. Разделение БД Shop и CRM (П6)
Выделение `crm_db`, миграция данных, интеграция через API/события.

### И11. Event sourcing заказов (П1, П8)
История статусов как поток событий, восстановление состояния из лога.

### И12. Ускорение расчёта MES (П5, П1)
Профилирование алгоритма, параллельные воркеры, кеширование повторов.

## 3. Инициативы в порядке приоритета

| Приоритет | № | Инициатива | Обоснование |
|-----------|---|------------|-------------|
| **1 (критично)** | И1 | Наблюдаемость | Без метрик и алертов не фиксируем сбои до жалоб; обязательна до И4. |
|  | И2 | RabbitMQ hardening | Требуется для нулевой потери сообщений. |
|  | И3 | Идемпотентность | Требует И2; исключает дубли и расхождения в заказах. |
| **2 (важно)** | И4 | Быстрый дашборд | Нужна для достижения P95 страницы <=2с и SLA назначения <=5 мин; запускается после И1. |
|  | И5 | Асинхронный B2B API | Обеспечивает ответ <=1с и готовность заказа <=30 мин. |
|  | И6 | API Gateway | Удерживает нагрузку B2B в пределах 100 req/min без деградации B2C; зависит от И5. |
|  | И9 | Автотесты | Сокращает регресс‑цикл и удерживает уровень дефектов после релиза. |
| **3 (средне)** | И7 | Масштабирование приложений | Обеспечивает работу при росте трафика ×3 без деградации. |
|  | И8 | Репликация БД | Снижает latency чтения и повышает отказоустойчивость; синхронно с И7. |
|  | И12 | Ускорение MES | Сохраняет SLA расчёта при росте сложности моделей. |
| **4 (долгосрочно)** | И10 | Отдельная CRM БД | Разделяет схемы Shop/CRM и убирает блокировки между доменами. |
|  | И11 | Event sourcing | Обеспечивает полный аудит статусов заказов, но требует серьёзной переработки.

## 4. Целевая архитектура через полгода

- Приложения Shop, CRM, MES: >=2 инстанса без сохранения состояния за балансировщиком, авто‑масштабирование при загрузке CPU >70%, целевое время работоспособности высокое. Ответственность - команда эксплуатации.
- API Gateway управляет внешним доступом, обеспечивает аутентификацию, rate limiting и маршрутизацию B2B/B2C. Ответственность - платформа/API.
- Данные: `shop_db`, `crm_db`, `mes_db` с master + две read‑реплики, целевая задержка репликации <=2 секунд; Redis для кеша и сессий. Ответственность - команда DBA.
- RabbitMQ: кластер из трёх нод с persisted очередями, DLQ и мониторингом SLA (длина очереди <=10k, задержка доставки <1 минуты). Ответственность - команда интеграций.
- Наблюдаемость: Prometheus, Grafana, Jaeger, централизованные логи и Alertmanager; MTTD <=5 минут, MTTR <=30 минут. Ответственность - DevOps + дежурные разработчики.
- CI/CD: критичные автотесты и дымовые тесты после деплоя, функциональные флаги для безопасных включений. Ответственность - команда разработки.

## 5. Топ-3 инициативы на ближайшие полгода

1. **И1 + И2 + И3** - обеспечивает достижение целевых показателей наблюдаемости и надёжности. **Цели:** MTTD <=5 минут, доля потерянных сообщений 0%, расхождение заказов Shop<>MES <=0.5%.
2. **И4** - выводит дашборд в заявленные SLA по отклику и распределению заказов. **Цели:** P95 страницы <=2 секунд, время назначения нового заказа оператору <=5 минут.
3. **И7 + И8** - фиксирует требуемый уровень устойчивости при кратном росте нагрузки. **Цели:** выдержка ×3 текущей нагрузки без деградации, аптайм 99.9%, replication lag <=2 секунд.

Остальные инициативы остаются в бэклоге: И5+И6 после стабилизации цепочки заказов, И9 при расширении команды, И10‑И12 после устранения критичных рисков.
