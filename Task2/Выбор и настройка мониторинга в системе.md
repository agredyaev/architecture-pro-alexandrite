# Выбор и настройка мониторинга в системе

## Мотивация

- Текущая телеметрия ограничена Яндекс Метрикой: видим только веб-сессии, нет данных по API, RabbitMQ, БД и B2B трафику.
- Последствия: потерянные заказы - неясно, на каком шаге цепочки Shop > MES > CRM они пропали. Высокая задержка дашборда MES - нет данных о 95-м перцентиле задержки и нагрузке. Инциденты замечаем только после жалоб клиентов.
- Ожидаемый результат: MTTD менее 5 минут, MTTR менее 30 минут, снижение жалоб в поддержку, рост пропускной способности операторов.
- Риски без мониторинга: ежемесячный рост +100 заказов при известной нагрузке, невозможность прогнозировать насыщение, потеря B2B контрактов.

## Выбор подхода к мониторингу

### RED Method для API сервисов (Shop API, CRM API, MES API)

**Метрики:** Rate (RPS), Errors (доля 5xx), Duration (задержка p50/p95/p99)

API сервисы - системы, управляемые запросами. RED показывает здоровье с точки зрения пользователя: Rate - рост RPS указывает на увеличение нагрузки, Errors - индикатор сбоев, Duration - увеличение времени ответа.

### USE Method для ресурсов (БД, RabbitMQ, CPU, Memory)

**Метрики:** Utilization (%), Saturation (queue depth), Errors (connection refused, OOM)

Ресурсы имеют фиксированную емкость. USE показывает приближение к лимитам: Utilization >80% = риск проблем, Saturation >0 = перегрузка, Errors = исчерпание.

### Бизнес-метрики (процесс обработки заказов)

**Метрики:** Заказы по статусам, время жизни заказа, DLQ messages

Технические метрики не отвечают на вопрос о потере заказов. Бизнес-метрики дают видимость критичных процессов.

## Метрики для отслеживания

Ниже перечислены метрики по компонентам с целями, ярлыками и порогами; Critical события отправляются в PagerDuty, остальные в Slack.

#### RabbitMQ
- `rabbitmq_dlq_messages{queue,reason}` - фиксирует необработанные заказы; порог >0 сообщений за 5 минут. **Источник:** RabbitMQ exporter, ответственность - команда интеграций.
- `rabbitmq_unacked_messages{queue,consumer}` - находит зависшие consumers; порог >100 сообщений 5 минут подряд. **Источник:** RabbitMQ exporter, ответственность - команда интеграций.
- `rabbitmq_queue_messages{queue}` - глубина очереди, отражает saturation; порог >1000 сообщений. **Источник:** RabbitMQ exporter, ответственность - команда интеграций.

#### API (RED)
- `http_requests_total{service,method,endpoint,status}` - базовый RPS и доля 5xx по каждому сервису. **Источник:** Prometheus SDK в сервисах, ответственность - команды Shop/CRM/MES.
- `http_requests_total{service,user_id,api_key}` - выявляет клиентов, превышающих лимиты (порог 100 req/min). **Источник:** тот же SDK (user_id/api_key), ответственность - платформа/API.
- `http_request_duration_seconds{service,endpoint,quantile}` - задержка p50/p95/p99 для каждого endpoint. **Источник:** Prometheus SDK, ответственность - команды сервисов.
- `http_responses_total{service,status}` - сверяем агрегированный уровень 2xx/5xx. **Источник:** Prometheus SDK, ответственность - команды сервисов.

#### Инфраструктура (USE)
- `node_cpu_seconds_total{service,instance,type}` с расчётом CPU % - контроль utilization, порог 80%. **Источник:** Node Exporter, ответственность - команда эксплуатации.
- `node_memory_active_bytes{service,instance}` и `process_resident_memory_bytes` - мониторинг утечек памяти. **Источник:** Node Exporter/Prometheus SDK, ответственность - команды сервисов + эксплуатация.
- `pg_stat_database_numbackends{database,state,application}` - использование соединений, критичен порог 80% от max_connections. **Источник:** Postgres Exporter, ответственность - DBA.
- `pg_database_size_bytes{database}` - рост БД, помогает capacity planning. **Источник:** Postgres Exporter, ответственность - DBA.
- `pg_stat_statement_mean_time_seconds{database,query_hash}` - медленные запросы, обращаем внимание при p95 >5 с. **Источник:** Postgres Exporter, ответственность - DBA совместно с командами сервисов.
- `node_filesystem_usage{instance,mountpoint}` - свободное дисковое пространство. **Источник:** Node Exporter, ответственность - команда эксплуатации.

#### Storage и сеть
- `aws_s3_bucket_size_bytes{bucket,storage_class}` - объём 3D-моделей и резервов. **Источник:** CloudWatch Exporter, ответственность - платформа/API + финансовый контроль.
- `node_network_transmit_bytes_total{instance,interface}` и `node_network_receive_bytes_total{...}` - нагрузка на сеть, отслеживаем скачки >10x. **Источник:** Node Exporter, ответственность - команда эксплуатации.

#### Бизнес-метрики
- `orders_total{status,channel}` - распределение заказов по стадиям, помогает увидеть стопоры. **Источник:** CRM (shop_db) и MES (mes_db) через ETL/экспортер, ответственность - продуктовая аналитика + CRM команда.
- `order_lifecycle_duration_seconds{from_status,to_status,channel}` - время прохождения статусов, целевое значение p95 менее 3 недель. **Источник:** CRM/MES события, ответственность - CRM команда.
- `orders_failed_total{channel,failure_reason}` - фиксирует неуспешные заказы; порог >0 за 5 минут. **Источник:** MES события + CRM интеграция, ответственность - команда интеграций.
- `operator_orders_total{operator_id}` - загрузка операторов для балансировки. **Источник:** MES, ответственность - операционная команда.

---

## План действий

1. **Неделя 1 - инфраструктура мониторинга.** Развернуть Prometheus с хранением 15 дней и Grafana, настроить HTTPS, при необходимости подключить S3-хранилище для долгосрочного хранения.
2. **Неделя 2 - инструментация приложений.** Подключить Prometheus SDK к Shop/CRM/MES, экспортировать RED и runtime метрики, добавить бизнес-счётчики заказов.
3. **Недели 2-3 - инфраструктурные экспортёры.** Node Exporter на всех инстансах, Postgres Exporter для shop_db и mes_db, RabbitMQ Prometheus plugin, CloudWatch Exporter для S3.
4. **Неделя 3 - дашборды.** Дашборды по сервисам с RED, по инфраструктуре, бизнес-дашборд с статусами заказов и DLQ.
5. **Недели 3-4 - алертинг.** Alertmanager с интеграциями Slack и PagerDuty, правила для DLQ, доли ошибок, соединений БД, задержки, глубины очередей, маршрутизация критичных в PagerDuty.
6. **Неделя 4 - инструкции и обучение.** Шаблон реакции на алерты, обучение команды работе с дашбордами, настройка ролей доступа.
7. **Непрерывно - улучшение.** Еженедельный разбор алертов, корректировка порогов, ежемесячное планирование мощностей и оптимизации.

---

## Показатели насыщенности (Saturation)

Saturation - сигналы, что ресурс достиг предела и очередь запросов начинает расти. Пороги приведены как примерные значения и требуют настройки под конкретную нагрузку.

- **CPU** (`node_load1 / cpu_count`): warning >0.7, critical >1.0 - значение >1 означает очередь на CPU. Действие: автоматическое или ручное масштабирование, профилировка горячих участков.
- **Memory** (`node_memory_SwapUsed_bytes`): warning - RAM >85% и swap >0, critical - swap >10% RAM. Swap резко увеличивает задержку. Действие: PagerDuty, поиск утечек памяти, вертикальное или горизонтальное масштабирование.
- **DB connections** (`pg_stat_database_numbackends / max_connections`): warning >70%, critical >90%. При превышении PostgreSQL отдаёт `too many clients`. Действие: завершить idle-сеансы, настроить PgBouncer, масштабирование.
- **RabbitMQ queue** (`rabbitmq_queue_messages`): warning >500, critical >2000 или рост >100 в минуту. Большая очередь означает, что consumers отстают. Действие: проверить consumers, перезапустить или масштабировать, включить приоритеты.
- **Disk I/O** (`node_disk_io_time_weighted_seconds_total`): warning >70%, critical >90%. Высокая занятость диска ведёт к росту задержки БД. Действие: оптимизация запросов, переход на более быстрый диск, кеширование.
- **Network** (`rate(node_network_transmit_bytes_total[1m]) / bandwidth_limit`): warning >70%, critical >90%. Лимиты пропускной способности EC2 вызывают потери пакетов. Действие: анализ трафика, защита от DDoS, апгрейд инстанса, использование CDN или сжатия.
