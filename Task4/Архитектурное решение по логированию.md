# Архитектурное решение по логированию

## 1. Анализ систем и логи уровня INFO

### Системы для сбора логов

| Система | Обоснование |
|---------|-------------|
| Shop API | Точка создания 100% заказов B2C, изменение статусов заказов |
| MES API | Расчет цены 2-30 минут, B2B API для партнеров, операции производства |
| CRM API | Подтверждение заказов, связь Shop и MES через RabbitMQ |
| RabbitMQ | Передача сообщений между системами, Dead Letter Queue |
| PostgreSQL shop_db | Операции с заказами, slow query |
| PostgreSQL mes_db | Операции производства, slow query |

### Каталог событий INFO

| Событие | Система | Поля | Назначение |
|---------|---------|------|------------|
| Создание заказа | Shop API | timestamp, order_id, user_id_hash, order_type | Начало жизненного цикла заказа |
| Изменение статуса заказа | Shop API, CRM API, MES API | timestamp, order_id, old_status, new_status, changed_by | Определение точки остановки заказа |
| Публикация сообщения RabbitMQ | Shop API, CRM API, MES API | timestamp, order_id, queue, message_id, routing_key | Контроль отправки |
| Получение сообщения RabbitMQ | MES API, CRM API | timestamp, order_id, queue, message_id, delivery_tag | Контроль доставки |
| Расчет цены завершен | MES API | timestamp, order_id, calculated_price, duration_ms, polygon_count | Анализ производительности расчетов |
| Сообщение в DLQ | RabbitMQ | timestamp, queue, reason, order_id, message_id | Обнаружение потери сообщений |
| Slow query | PostgreSQL | timestamp, db, statement_hash, duration_ms, rows, order_id | Поиск узких мест БД |

Формат: JSON. Обязательные поля: timestamp, trace_id, span_id. Поле order_id - где применимо.

## 2. Другие уровни логирования

| Уровень | Условия использования | Retention |
|---------|----------------------|-----------|
| DEBUG | Включается через feature flag на срок до 24 часов при расследовании инцидентов | 7 дней |
| WARN | Деградация без потери данных: таймаут внешнего API, retry RabbitMQ, приближение к SLA | 60 дней |
| ERROR | Необработанные исключения, потеря данных, отказ критичных ресурсов | 90 дней |
| FATAL | Полный отказ сервиса, требует немедленного вмешательства | 90 дней |

Production: INFO, WARN, ERROR, FATAL.

## 3. Мотивация

### Текущие проблемы

- Потеря нескольких крупных B2B контрактов из-за невозможности диагностировать проблемы с заказами
- Рост обращений в поддержку: более 18 в неделю по статусу заказов
- Разбор инцидентов со слов клиента
- Логи Shop, MES, CRM, RabbitMQ не связаны

### Целевые метрики

Технические метрики:

| Метрика | Текущее значение | Целевое значение |
|---------|------------------|------------------|
| Среднее время обнаружения инцидента | не измеряется | менее 10 минут |
| Среднее время устранения инцидента | не измеряется | менее 1 часа |
| Доля неуспешных publish RabbitMQ | не измеряется | менее 0.5% |
| P95 latency от создания заказа до расчета цены | не измеряется | менее 45 минут |

Бизнес-метрики:

| Метрика | Текущее значение | Целевое значение |
|---------|------------------|------------------|
| Обращения в поддержку по статусу заказа | более 18 в неделю | менее 5 в неделю |
| Заказы без расчета цены через 30 минут | неизвестно | менее 1% |

## 4. Приоритет систем для логирования и трейсинга

| Приоритет | Система | Обоснование логирования | Обоснование трейсинга |
|-----------|---------|-------------------------|----------------------|
| 1 | Shop API | 100% заказов B2C проходят через Shop API | Связь событий в цепочке запросов |
| 1 | MES API | Расчет цены 2-30 минут требует контроля | End-to-end трейсинг долгих операций |
| 1 | RabbitMQ | Обнаружение потери сообщений через DLQ | Связь publish и consume |
| 2 | CRM API | Аудит утверждения заказов | Замыкание цепочки Shop - MES |
| 2 | PostgreSQL | Диагностика slow query и deadlock | Связь SQL запроса с цепочкой вызовов |
| 3 | Инфраструктура | Редкие инциденты: OOM, disk full | Подключение после охвата приложений |

Команда не может реализовать логирование и трейсинг всех систем одновременно.

## 5. Предлагаемое решение

### Архитектура

Компоненты:

- Источники: Shop API, CRM API, MES API, RabbitMQ, PostgreSQL пишут JSON в stdout
- Сбор: Promtail на каждом сервере собирает логи, фильтрует персональные данные, добавляет метки service и env
- Хранение: Grafana Loki индексирует по меткам, хранит в S3
- Визуализация: Grafana для поиска логов по order_id, trace_id
- Алертинг: Alertmanager получает события от Loki и Prometheus

Технологии:

- Promtail: агент сбора логов
- Grafana Loki: индексация и хранение логов
- S3: долгосрочное хранилище
- Grafana: единый интерфейс для логов, метрик, трейсов
- Alertmanager: маршрутизация оповещений

Интеграция с трейсингом: поля trace_id и span_id в JSON связывают логи с трейсами в Jaeger.

### Архитектурная схема

![Архитектура логирования](./diag/logging-architecture-diagram.png)

Диаграмма C4: [./diag/logging-architecture-diagram.puml](./diag/logging-architecture-diagram.puml)

## 6. Политика безопасности

### Обработка чувствительных данных

- Приложения исключают поля auth_token, password, user.email до записи в stdout
- Приложения хешируют user_id как user_id_hash через SHA-256 с salt
- Promtail маскирует phone, address через pipeline replace

### Контроль доступа

| Роль | Доступ | Механизм |
|------|--------|----------|
| Support | Чтение логов | OAuth2 + VPN, роль Support в SSO |
| DevOps | Чтение логов, управление алертами | OAuth2 + VPN, роль DevOps в SSO |
| Security | Аудит доступа | OAuth2 + VPN, роль Security в SSO |

### Защита передачи

- TLS 1.2 на маршрутах Promtail - Loki и Loki - S3
- Доступ к Grafana только через VPN

### Аудит

Обращения к Grafana и Loki логируются в отдельный индекс audit с retention 180 дней.

## 7. Политика хранения

### Retention по уровням

| Уровень | Срок хранения | Хранилище | Параметры |
|---------|---------------|-----------|-----------|
| DEBUG | 7 дней | S3 logs-debug | gzip, автоудаление |
| INFO | 30 дней | S3 logs-info | gzip, автоудаление |
| WARN | 60 дней | S3 logs-warn | gzip, автоудаление |
| ERROR/FATAL | 90 дней | S3 logs-error | gzip, затем Glacier |
| Аудит | 180 дней | S3 logs-audit | gzip, автоудаление |

### Индексация

Loki индексирует по меткам: service, env, level, host.

### Размер

Оценка при 100 заказов в день, рост на 100 заказов в день каждый месяц, средний размер события 2 КБ:

- Месяц 1: ~15 ГБ
- Месяц 6: ~90 ГБ
- Год 1: ~540 ГБ накопленно

Стоимость S3 Standard ~0.023 USD за ГБ в месяц <https://aws.amazon.com/s3/pricing/>

## 8. Алертинг и анализ аномалий

### Алертинг

Правила:

| Правило | Условие | Severity | Канал |
|---------|---------|----------|-------|
| RabbitMQDeadLetterRate | Более 1 сообщения в DLQ за 5 минут в течение 10 минут | high | Slack |
| ShopErrorRate | Доля ERROR более 2% от INFO в течение 15 минут | critical | Slack |
| SlowPriceCalc | P95 длительности расчета цены более 45 минут | warning | Slack |

Маршрутизация:

- warning: Slack канал incidents
- critical: Slack канал incidents, эскалация дежурному

### Анализ аномалий

Детектирование:

- Превышение медианы создания заказов за 3 часа более чем в 10 раз
- Превышение медианы изменения статусов за 3 часа более чем в 5 раз

Действия:

- Автоматическое создание alert в Slack
- Ручная проверка логов через Grafana
- Корреляция с трейсами в Jaeger

## 9. Критерии выбора технологии

### Сравнительная таблица

| Критерий | Grafana Loki | OpenSearch | Elastic Stack | Splunk |
|----------|--------------|------------|---------------|--------|
| Лицензия | AGPL v3 | Apache 2.0 | Elastic License | Проприетарная |
| Стоимость хранения | S3 backend ~0.023 USD за ГБ в месяц | OpenSearch Service data nodes + EBS | Elastic Cloud или self-managed | Лицензия на объем ingest |
| Масштабирование | Роли distributor, ingester, querier, compactor | Автошардинг по data nodes | Master, data, coordinating nodes | Масштабирование через лицензию |
| Запросы | LogQL, нативная интеграция trace_id | Query DSL JSON | KQL, Lucene | SPL проприетарный |
| Интеграция с Grafana, Prometheus | Нативная | Требуются плагины | Требуется Kibana | Требуются коннекторы |
| Эксплуатация | Go компоненты, YAML конфигурация | Управление JVM, snapshots | Управление JVM, лицензии | SaaS управление |
| Экспертиза команды | Используется Grafana, Promtail PoC | Ограниченная | Частичная | Отсутствует |

### Обоснование выбора Grafana Loki

Преимущества:

- Минимальная стоимость хранения через S3 backend
- Нативная интеграция с существующими Grafana и Prometheus
- Команда уже использует Grafana, минимальное обучение
- Интеграция с Jaeger через trace_id
- AGPL v3 без ограничений функциональности

Недостатки:

- Ограниченные возможности full-text search по сравнению с Elastic
- Требуется настройка multi-tenant изоляции через метки

Вывод: Grafana Loki оптимально для задачи.
